{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load common_tags %}
{% load static %}


{% block title %}
Move Allocation
{% endblock %}


{% block content %}
<h2>Move Allocation to a Different Project</h2>
<hr>

<p>
  You can move an allocation from this project to another you own as long as the other project does
  not reach any limits, i.e. the maximum allowed for this resource the project can have. NOTE: Users
  will also be moved over within the allocation. Any users missing from the project will
  automatically be added to it. If there are users you do not want included in the move then remove
  them from the allocation first. If this is a compute allocation then when you move it over to the
  other project you will be given a new slurm account to use. For storage allocations this will not
  affect how you access your storage.
</p>

<form action="{% url 'move-allocation' allocation.pk %}" method="post">
  {% csrf_token %}
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h3>Current Project</h3>
        </div>
        <div class="card-body">
          <fieldset>
            <legend><strong><u>Project Info</u></strong></legend>
            <p><strong>ID:</strong> {{ allocation.project.pk }}</p>
            <p><strong>Title:</strong> {{ allocation.project.title }}</p>
            <p><strong>Project Description:</strong> {{ allocation.project.description }}</p>
            <p><strong>Project Type:</strong> {{ allocation.project.type }}</p>
            <p><strong>End Date:</strong> {{ allocation.project.end_date }}</p>
          </fieldset>
          <hr>
          <fieldset>
            <legend><strong><u>Allocation Info</u></strong></legend>
            <p><strong>Resource:</strong> {{ allocation.get_parent_resource.name }}</p>
            <p><strong>End Date:</strong> {{ allocation.end_date }}</p>
            <div>
              <strong>Users:</strong>
              <ul>
                {% for user in allocation_users %}
                <li>{{ user.user.first_name }}, {{ user.user.last_name}} ({{ user.user.username }})</li>
                {% endfor %}
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <h4>Attributes</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered table-sm">
                    <thead>
                      <tr>
                        <th scope="col">Attribute</th>
                        <th scope="col">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for attribute in allocation_attributes %}
                      <tr>
                        <td>{{attribute}}</td>
                        <td>{{attribute.value}}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
    <div style="display: flex; align-items: center;">
      <i class="fas fa-angle-double-right"></i>
    </div>
    <div class="col">
      <div class="card">
        <div class="card-header">
          <div class="row">
            <div class="col">
              <label for="id_new_project">
                <h3 class="m-0">{{ form.new_project.label|title }}</h3>
              </label>
            </div>
            <div class="col">
              {{ form.new_project }}
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="id_new_project_info"></div>
        </div>
        <div class="card-footer">
          <button id="id_submit" class="btn btn-primary float-right" type="submit">Move Into</button>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  $(document).ready(function () {
    $('#id_new_project').addClass('form-control')
    $('#id_new_project').change(function (e) {
      var project_pk = $("#id_new_project option:selected").val();
      if (!project_pk) {
        $('#id_new_project_info').html('')
        return;
      }

      $('#id_new_project_info').html(
        '<i class="fas fa-sync fa-spin fa-fw" aria-hidden="true"></i> Grabbing project information...'
      );
      $.ajax({
        url: `project-info/${project_pk}`,
        success: function (data) {
          $('#id_new_project_info').html(data)
          var not_moveable = $('#id_not_moveable');
          console.log(not_moveable.length);
          if (not_moveable.length) {
            $('#id_submit').prop('disabled', true)
          } else {
            $('#id_submit').prop('disabled', false)
          }
        },
        error: function (data) {
          $('#id_new_project_info').html(
            `<div class="alert alert-danger m-0">
              <i class="fa fa-info-circle" aria-hidden="true"></i> An error has occured.
            </div>`
          )
        }
      })
    })
    $('#id_new_project_info')
  })
</script>

{% endblock %}