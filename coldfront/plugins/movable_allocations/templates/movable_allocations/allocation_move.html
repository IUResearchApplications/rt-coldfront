{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load common_tags %}
{% load static %}


{% block title %}
Move Allocation
{% endblock %}


{% block content %}
<h2>Move {{ allocation.get_parent_resource.name }} Allocation to a Different Project</h2>
<hr>

<p>
  Allocations can be moved to another project as long as the other project's
  restrictions are not met, i.e. max allocations allowed for this resource in the project. <strong>
  Users in the allocation are also moved over and anyone missing from the destination project are
  automatically added to it. If there are users that should not be moved then they need to be removed
  from the allocation first.</strong> Compute allocations being moved will be given a new slurm
  account. Storage allocation file system access will not be effected.
</p>

<form action="{% url 'move-allocation' allocation.pk %}" method="post">
  {% csrf_token %}
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h3>Current</h3>
        </div>
        <div class="card-body">
          <fieldset>
            <legend>
              <strong><u>Project Info</u></strong>
              <a href="{% url 'project-detail' allocation.project.pk %}" target="_blank">
                <i class="fas fa-external-link-alt" aria-hidden="true"></i>
              </a>
            </legend>
            <p><strong>ID:</strong> {{ allocation.project.pk }}</p>
            <p><strong>Title:</strong> {{ allocation.project.title }}</p>
            <p>
              <strong>PI:</strong>
              {{ allocation.project.pi.first_name }} {{ allocation.project.pi.last_name }}
              ({{ allocation.project.pi.username }})
            </p>
            <p><strong>Project Description:</strong> {{ allocation.project.description }}</p>
            <p><strong>Project Type:</strong> {{ allocation.project.type }}</p>
            <p><strong>Project Status:</strong> {{ allocation.project.status }}</p>
            <p><strong>End Date:</strong> {{ allocation.project.end_date }}</p>
          </fieldset>
          <hr>
          <fieldset>
            <legend><strong><u>Allocation Info</u></strong></legend>
            <p><strong>Resource:</strong> {{ allocation.get_parent_resource.name }}</p>
            <p><strong>End Date:</strong> {{ allocation.end_date }}</p>
            <div>
              <strong>Users:</strong>
              <ul>
                {% for user in allocation_users %}
                <li>{{ user.user.first_name }}, {{ user.user.last_name}} ({{ user.user.username }})</li>
                {% endfor %}
              </ul>
            </div>
            <div class="card">
              <div class="card-header">
                <h4>Attributes</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered table-sm">
                    <thead>
                      <tr>
                        <th scope="col">Attribute</th>
                        <th scope="col">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for attribute in allocation_attributes %}
                      <tr>
                        <td>{{attribute}}</td>
                        <td>{{attribute.value}}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
    <div style="display: flex; align-items: center;">
      <i class="fas fa-angle-double-right"></i>
    </div>
    <div class="col">
      <div class="card">
        <div class="card-header">
          <div class="row">
            <div class="col">
              <label for="id_destination_project">
                <h3 class="m-0">Destination</h3>
              </label>
            </div>
            <div class="col">
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                </div>
                {{ form.destination_project }}
                <div class="input-group-append">
                  <button id="id_search_project" class="btn btn-outline-secondary" type="button">Search</button>
                </div>
              </div>
              
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="id_destination_project_info"></div>
        </div>
        <div class="card-footer">
          <a href="{% url 'allocation-detail' allocation.pk %}" class="btn btn-secondary float-right">
            Cancel
          </a>
          <button id="id_submit" class="btn btn-primary float-right confirm-move mr-1" type="submit">
            <i class="fas fa-angle-double-right"></i>  Move Into
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

<script>
  $(document).on('click', '.confirm-move', function () {
    if (!$('#id_destination_project').val()) {
      return;
    }
    var confirmation = confirm('Are you sure you want to move this allocation? All of the users in this allocation will be added to the destination project if they do not exist already.');
    if (!confirmation) {
      return confirmation
    }
    $('#id_submit').html(
      '<i class="fas fa-sync fa-spin fa-fw" aria-hidden="true"></i> Moving allocation...'
    );
    return confirmation
  })
  $(document).ready(function () {
    $('#id_destination_project').addClass('form-control')
    $('#id_search_project').click(function (e) {
      var project_pk = $("#id_destination_project").val();
      if (!project_pk) {
        $('#id_destination_project_info').html('')
        return;
      }

      $('#id_destination_project_info').html(
        '<i class="fas fa-sync fa-spin fa-fw" aria-hidden="true"></i> Grabbing project information...'
      );
      $.ajax({
        url: `project-info/${project_pk}`,
        success: function (data) {
          $('#id_destination_project_info').html(data)
          var not_moveable = $('#id_not_moveable');
          if (not_moveable.length) {
            $('#id_submit').prop('disabled', true)
          } else {
            $('#id_submit').prop('disabled', false)
          }
        },
        error: function (data) {
          $('#id_destination_project_info').html(
            `<div class="alert alert-danger m-0">
              <i class="fa fa-info-circle" aria-hidden="true"></i> An error has occured.
            </div>`
          )
        }
      })
    })
    $('#id_destination_project_info')
  })
</script>

{% endblock %}